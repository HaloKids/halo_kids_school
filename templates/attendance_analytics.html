{% extends 'base.html' %}
{% block content %}
<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark"><i class="bi bi-pie-chart-fill"></i> Attendance Analytics</h2>
            <p class="text-muted">Overview of student presence across all classes.</p>
        </div>
        <a href="{% url 'super_dashboard' %}" class="btn btn-outline-secondary">Back to Hub</a>
    </div>

    <div class="card shadow border-0 mb-5">
        <div class="card-header bg-success text-white fw-bold">
            <i class="bi bi-file-earmark-spreadsheet"></i> Export Attendance Reports
        </div>
        <div class="card-body">
            <div class="row g-4">
                
                <div class="col-md-6 border-end">
                    <h6 class="fw-bold text-secondary">Option 1: Daily Report</h6>
                    <form action="{% url 'download_attendance_report' %}" method="GET" class="d-flex gap-2">
                        <input type="hidden" name="mode" value="date">
                        <input type="date" name="date" class="form-control" required>
                        <button type="submit" class="btn btn-outline-success fw-bold text-nowrap">
                            <i class="bi bi-download"></i> Download Day
                        </button>
                    </form>
                    <small class="text-muted">Best for checking a specific day's absentees.</small>
                </div>

                <div class="col-md-6">
                    <h6 class="fw-bold text-secondary">Option 2: Monthly Report</h6>
                    <form action="{% url 'download_attendance_report' %}" method="GET" class="d-flex gap-2">
                        <input type="hidden" name="mode" value="month">
                        <input type="month" name="month" class="form-control" required>
                        <button type="submit" class="btn btn-dark fw-bold text-nowrap">
                            <i class="bi bi-download"></i> Download Month
                        </button>
                    </form>
                    <small class="text-muted">Best for monthly records and salary calculation.</small>
                </div>

            </div>
        </div>
    </div>

    <h5 class="fw-bold text-secondary mb-3">Quick View (On Screen)</h5>
    <div class="card shadow-sm border-0 mb-4 bg-light">
        <div class="card-body">
            <form method="GET" class="d-flex align-items-center gap-3">
                <label class="fw-bold text-nowrap">Select Date to View:</label>
                <input type="date" name="date" class="form-control w-auto" value="{{ selected_date|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-primary fw-bold">View Data</button>
            </form>
        </div>
    </div>

    <div class="row g-3 mb-5">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-success">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted fw-bold small">School-wide Presence</h6>
                    <div class="d-flex align-items-baseline">
                        <h2 class="fw-bold text-success mb-0">{{ school_percentage }}%</h2>
                        <span class="ms-2 text-muted small">Attendance Rate</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-primary">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted fw-bold small">Present Today</h6>
                    <div class="d-flex align-items-baseline">
                        <h2 class="fw-bold text-primary mb-0">{{ present_today }}</h2>
                        <span class="ms-2 text-muted small">Students</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-danger">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted fw-bold small">Absent / Leave</h6>
                    <div class="d-flex align-items-baseline">
                        <h2 class="fw-bold text-danger mb-0">{{ absent_today }}</h2>
                        <span class="ms-2 text-muted small">Students</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white fw-bold py-3">
            üè´ Class-wise Attendance Report for {{ selected_date|date:"F d, Y" }}
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary text-uppercase small">
                        <tr>
                            <th class="ps-4">Class</th>
                            <th class="text-center">Total Students</th>
                            <th class="text-center">Status</th>
                            <th class="text-center text-success">Present</th>
                            <th class="text-center text-danger">Absent</th>
                            <th class="text-center text-warning">Leave</th>
                            <th style="width: 25%;">Attendance %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in class_data %}
                        <tr>
                            <td class="ps-4 fw-bold">{{ row.class_name }}</td>
                            <td class="text-center fw-bold">{{ row.total_students }}</td>
                            
                            <td class="text-center">
                                {% if row.status == 'Pending' %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> Not Taken</span>
                                {% else %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Completed</span>
                                {% endif %}
                            </td>

                            <td class="text-center fw-bold text-success">{{ row.present }}</td>
                            <td class="text-center fw-bold text-danger">{{ row.absent }}</td>
                            <td class="text-center fw-bold text-dark">{{ row.leave }}</td>
                            
                            <td>
                                {% if row.status == 'Taken' %}
                                    <div class="d-flex align-items-center">
                                        <span class="me-2 fw-bold small">{{ row.percentage }}%</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar 
                                                {% if row.percentage >= 90 %}bg-success
                                                {% elif row.percentage >= 75 %}bg-info
                                                {% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ row.percentage }}%;">
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted small">--</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                No classes found. Please register students first.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}